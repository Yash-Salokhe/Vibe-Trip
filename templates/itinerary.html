<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeTrip</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --text: #1e293b; --card: #ffffff; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        .layout { display: grid; grid-template-columns: 1fr 400px; height: 100vh; }
        
        .itinerary-pane { padding: 40px; overflow-y: auto; scroll-behavior: smooth; }
        .day-card { background: var(--card); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 6px solid var(--primary); }
        .day-title { margin: 0 0 15px 0; color: var(--primary); font-size: 1.25rem; }
        .activity-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f1f5f9; align-items: flex-start; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { color: var(--primary); margin-top: 3px; font-size: 0.9rem; }
        
        .chat-pane { background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .chat-header { padding: 20px; border-bottom: 1px solid #f1f5f9; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
        .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bot { background: #f1f5f9; color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; }
        
        .input-area { padding: 20px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px; }
        input { flex-grow: 1; border: 1px solid #e2e8f0; padding: 12px; border-radius: 10px; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 10px; cursor: pointer; }

        .loading-container { text-align: center; margin-top: 100px; }
        .spinner { animation: spin 1s linear infinite; color: var(--primary); font-size: 3rem; }
        @keyframes spin { 100% { transform: rotate(360deg); } }


.chat-pane { 
    background: white; 
    border-left: 1px solid #e2e8f0; 
    display: flex; 
    flex-direction: column; 
    height: 100vh; 
    overflow: hidden; 
}

#chat-box { 
    flex: 1; 
    overflow-y: scroll;
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    gap: 12px; 
    background: #ffffff;
    scroll-behavior: smooth;
}
    </style>
</head>
<body>

<div class="layout">
    <div class="itinerary-pane" id="itinerary-pane">
        <div id="loading-zone" class="loading-container">
            <i class="fas fa-circle-notch spinner"></i>
            <p>Mapping your vibes...</p>
        </div>
    </div>

    <div class="chat-pane">
        <div class="chat-header"><i class="fas fa-robot"></i> VibeTrip Assistant</div>
        <div id="chat-box"></div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Ask a question or change the plan...">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const state = {
        location: urlParams.get('location') || 'Your Destination',
        days: parseInt(urlParams.get('days')) || 3,
        vibes: urlParams.get('vibes') ? urlParams.get('vibes').split(',') : [],
        history: [] 
    };

    async function init() {
        await fetchUpdate();
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        addMessage('user', text);
        input.value = '';
        await fetchUpdate();
    }

    async function fetchUpdate() {
        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(state)
            });
            const data = await response.json();
            processResponse(data);
        } catch (err) {
            addMessage('bot', "I'm having trouble parsing the response. Please try again.");
            console.error(err);
        }
    }

    function processResponse(data) {
        
        if (data.travel_tips) {
            addMessage('bot', data.travel_tips);
        }

        
        const loading = document.getElementById('loading-zone');
        if (loading) loading.remove();

    
        const itinerary = data.structured_itinerary || data.itinerary;
        const hasData = itinerary && itinerary.length > 0 && itinerary.some(d => d.activities && d.activities.length > 0);

        if (hasData) {
            renderItinerary(itinerary);
        } else if (document.getElementById('itinerary-pane').innerHTML.trim() === "") {
        
            document.getElementById('itinerary-pane').innerHTML = "<h3>Itinerary ready! Check the chat for details.</h3>";
        }
    }

    function renderItinerary(days) {
        const pane = document.getElementById('itinerary-pane');
        pane.innerHTML = `<h1>Trip to ${state.location}</h1>`;

        days.forEach(day => {
            const card = document.createElement('div');
            card.className = 'day-card';
            card.innerHTML = `
                <h3 class="day-title">Day ${day.day}: ${day.theme || day.title || "Daily Exploration"}</h3>
                <div class="activity-list">
                    ${day.activities.map(act => {
                        
                        const desc = (typeof act === 'object' && act !== null) ? 
                                     (act.activity || act.location || act.name || act.description) : act;
                        return `
                            <div class="activity-item">
                                <i class="fas fa-map-marker-alt activity-icon"></i>
                                <span>${desc}</span>
                            </div>`;
                    }).join('')}
                </div>`;
            pane.appendChild(card);
        });
    }

    function addMessage(role, text) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        
        state.history.push({ role, content: text });
    }

    init();
</script>
</body>
</html>